@model clinicSystem.Models.Entities.Appointment
@{
    ViewData["Title"] = "New Appointment";
}

@if (TempData["PopupData"] != null)
{
    <div id="popup">
        <pre id="popupContent">@TempData["PopupData"]</pre>
        <button onclick="closePopup()" class="btn btn-secondary">Ok</button>
    </div>
    <div id="overlay"></div>
}

<div class="container my-5 animate__animated animate__fadeIn">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="text-success fw-bold display-5">Create New Appointment</h1>
        <a class="btn btn-outline-danger btn-lg shadow-sm animate__animated animate__fadeInDown" href="/Appointment/Index">
            <i class="bi bi-arrow-left-circle"></i> Back
        </a>
    </div>

    @using (Html.BeginForm("SaveNew", "Appointment", FormMethod.Post))
    {
        <div class="row g-3">
            <div class="col-md-6">
                <div class="form-floating mb-3">
                    @Html.DropDownListFor(m => m.PatientId, (SelectList)ViewBag.Patients, "-- Select Patient --", new { @class = "form-select" })
                    @Html.LabelFor(m => m.Patient)
                </div>
            </div>

            <div class="col-md-6">
                <div class="form-floating mb-3">
                    @Html.DropDownListFor(m => m.DoctorId, (SelectList)ViewBag.Doctors, "-- Select Doctor --", new { @class = "form-select", id = "doctorSelect" })
                    @Html.LabelFor(m => m.Doctor)
                </div>
            </div>

            <div class="col-md-4">
                <div class="form-floating mb-3">
                    @Html.TextBoxFor(m => m.AppointmentDate,  new { @class = "form-control", type = "date", id = "appointmentDate" })
                    @Html.LabelFor(m => m.AppointmentDate)
                </div>
            </div>

            <div class="col-md-4">
                <div class="form-floating mb-3">
                    @Html.DropDownListFor(m => m.AppointmentTime, new List<SelectListItem>(), "-- Select Available Time --", new { @class = "form-select", id = "appointmentTime" })
                    @Html.LabelFor(m => m.AppointmentTime)
                </div>
            </div>

            <div class="col-md-4">
                <div class="form-floating mb-3">
                    @Html.TextBoxFor(m => m.Duration, new { @class = "form-control", type = "number", min = "1" })
                    @Html.LabelFor(m => m.Duration)
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-center mt-4">
            <button type="submit" class="btn btn-success btn-lg px-5 shadow-sm animate__animated animate__pulse">
                <i class="bi bi-plus-circle-dotted"></i> Add Appointment
            </button>
        </div>
    }
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>
        function loadFreeSlots() {
            var doctorId = $("#doctorSelect").val();
            var date = $("#appointmentDate").val();
            if (!doctorId || !date) return;
            $.getJSON('/Appointment/GetFreeSlots', { doctorId: doctorId, appointmentDate: date }, function (data) {
                availableSlots = data;
                var timeSelect = $("#appointmentTime");
                timeSelect.empty();

                if (availableSlots.length === 0) {
                    timeSelect.append($('<option>').text("No available slots").attr("disabled", true));
                } else {
                    $.each(availableSlots, function (i, val) {
                        // نحول الوقت من 24 إلى 12 ساعة مع AM/PM
                        let [hours, minutes] = val.split(':');
                        hours = parseInt(hours);
                        const ampm = hours >= 12 ? 'PM' : 'AM';
                        hours = hours % 12 || 12; // تحويل 0 أو 12 إلى 12
                        const formattedTime = `${hours}:${minutes} ${ampm}`;

                        timeSelect.append($('<option>').text(formattedTime).val(val));
                    });
                }
            });

        }

        $("#doctorSelect, #appointmentDate").change(loadFreeSlots);
    </script>
}
